

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Event log &mdash; Eventuate</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Eventuate" href="../index.html"/>
        <link rel="up" title="Reference" href="../reference.html"/>
        <link rel="next" title="Event-sourced actors" href="event-sourcing.html"/>
        <link rel="prev" title="API docs" href="api-docs.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

  
	<script src="//fonts.redbullmediahouse.com/snv5vzo.js"></script>
	<script>try{Typekit.load();}catch(e){}</script>
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        
          
          <a href="../index.html"><img src="../_static/RedBullMediaHouse-dark.png" class="logo" /></a>
        
        
		
<div role="search" class="searchbox">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search Eventuate" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
	
        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">Architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#event-logs">Event logs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#event-sourced-actors">Event-sourced actors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#event-sourced-views">Event-sourced views</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#event-sourced-processors">Event-sourced processors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#operation-based-crdts">Operation-based CRDTs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#vector-clocks">Vector clocks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#batching">Batching</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#adapters">Adapters</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../download.html">Download</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../download.html#binaries">Binaries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../download.html#sources">Sources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user-guide.html">User guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user-guide.html#event-sourced-actors">Event-sourced actors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide.html#detecting-concurrent-updates">Detecting concurrent updates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide.html#tracking-conflicting-versions">Tracking conflicting versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide.html#resolving-conflicting-versions">Resolving conflicting versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide.html#operation-based-crdts">Operation-based CRDTs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide.html#event-sourced-views">Event-sourced views</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide.html#conditional-commands">Conditional commands</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../reference.html">Reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="api-docs.html">API docs</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Event log</a></li>
<li class="toctree-l2"><a class="reference internal" href="event-sourcing.html">Event-sourced actors</a></li>
<li class="toctree-l2"><a class="reference internal" href="event-sourcing.html#event-sourced-views">Event-sourced views</a></li>
<li class="toctree-l2"><a class="reference internal" href="event-sourcing.html#state-recovery">State recovery</a></li>
<li class="toctree-l2"><a class="reference internal" href="event-sourcing.html#snapshots">Snapshots</a></li>
<li class="toctree-l2"><a class="reference internal" href="event-sourcing.html#event-routing">Event routing</a></li>
<li class="toctree-l2"><a class="reference internal" href="event-sourcing.html#reliable-delivery">Reliable delivery</a></li>
<li class="toctree-l2"><a class="reference internal" href="event-sourcing.html#custom-serialization">Custom serialization</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html">Configuration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../developers.html">Developers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../developers.html#contributing-to-eventuate">Contributing to Eventuate</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developers.html#building-eventuate">Building Eventuate</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../project.html">Project</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../project.html#community">Community</a></li>
<li class="toctree-l2"><a class="reference internal" href="../project.html#license">License</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../articles.html">Articles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">FAQ</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../faq.html#how-does-eventuate-compare-to-akka-persistence">How does Eventuate compare to Akka Persistence?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../example-application.html">Example application</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../example-application.html#domain">Domain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example-application.html#replication">Replication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example-application.html#interface">Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example-application.html#running">Running</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../current-limitations.html">Current limitations</a></li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html"><img src="../_static/RedBullMediaHouse-light.png" class="logo" /></a>
      </nav>
 
      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li>
		<a href="../index.html"><h2><span class="breadcrumbicon rbicons topfront"><i class="fa fa-calendar"></i></span>Eventuate</h2></a> &raquo;
	</li>
    
    <li><a href="../reference.html">Reference</a> &raquo;</li>
    
    <li>Event log</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="event-log">
<span id="id1"></span><h1>Event log<a class="headerlink" href="#event-log" title="Permalink to this headline">¶</a></h1>
<div class="section" id="local-event-log">
<span id="id2"></span><h2>Local event log<a class="headerlink" href="#local-event-log" title="Permalink to this headline">¶</a></h2>
<p>A local event log belongs to a given <em>location</em><a class="footnote-reference" href="#id10" id="id3">[1]</a> and a location can have one or more local event logs. Depending on the storage backend, a local event log may optionally be replicated within that location for stronger durability guarantees but this is rather an implementation details of the local event log. From Eventuate’s perspective, event replication occurs between different locations which is further described in section <a class="reference internal" href="#replicated-event-log"><span>Replicated event log</span></a>.</p>
<p>To an application, an event log is represented by an event log actor. Producers and consumer interact with that actor to write events to and read events from an event log. They can also register at the event log actor to be notified about newly written events. The messages that can be exchanged with an event log actor are defined in <a class="reference external" href="../latest/api/index.html#com.rbmhtechnology.eventuate.EventsourcingProtocol$">EventsourcingProtocol</a>.</p>
<p>At the moment, two storage backends are supported by Eventuate, <a class="reference external" href="https://github.com/google/leveldb">LevelDB</a> and <a class="reference external" href="http://cassandra.apache.org/">Cassandra</a>. The corresponding event log actors are provided by Eventuate and their usage is explained in the following sections.</p>
<div class="section" id="leveldb-storage-backend">
<span id="id4"></span><h3>LevelDB storage backend<a class="headerlink" href="#leveldb-storage-backend" title="Permalink to this headline">¶</a></h3>
<p>A local event log actor with a LevelDB storage backend writes events to the local file system. It can be created with:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">akka.actor.ActorSystem</span>
<span class="k">import</span> <span class="nn">com.rbmhtechnology.eventuate.log.leveldb.LeveldbEventLog</span>

<span class="k">val</span> <span class="n">system</span><span class="k">:</span> <span class="kt">ActorSystem</span> <span class="o">=</span> <span class="c1">// ...</span>
<span class="k">val</span> <span class="n">log</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">LeveldbEventLog</span><span class="o">.</span><span class="n">props</span><span class="o">(</span><span class="n">logId</span> <span class="k">=</span> <span class="s">&quot;L1&quot;</span><span class="o">,</span> <span class="n">prefix</span> <span class="k">=</span> <span class="s">&quot;log&quot;</span><span class="o">))</span>
</pre></div>
</div>
<p>Applications must provide a unique <code class="docutils literal"><span class="pre">logId</span></code> for that log, the <code class="docutils literal"><span class="pre">prefix</span></code> is optional and defaults to <code class="docutils literal"><span class="pre">log</span></code>. This will create a directory <code class="docutils literal"><span class="pre">log-L1</span></code> in which the LevelDB files are stored. The root directory of all local LevelDB directories can be configured with the <code class="docutils literal"><span class="pre">eventuate.log.leveldb.dir</span></code> configuration key in <code class="docutils literal"><span class="pre">application.conf</span></code>:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">eventuate</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">leveldb</span><span class="o">.</span><span class="n">dir</span> <span class="k">=</span> <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">eventuate</span>
</pre></div>
</div>
<p>With this configuration, the absolute path of the LevelDB directory in the above example is <code class="docutils literal"><span class="pre">/var/eventuate/log-L1</span></code>. If not configured, <code class="docutils literal"><span class="pre">eventuate.log.leveldb.dir</span></code> defaults to <code class="docutils literal"><span class="pre">target</span></code>. Further <code class="docutils literal"><span class="pre">eventuate.log.leveldb</span></code> configuration options are given in section <a class="reference internal" href="configuration.html#configuration"><span>Configuration</span></a>.</p>
</div>
<div class="section" id="cassandra-storage-backend">
<span id="id5"></span><h3>Cassandra storage backend<a class="headerlink" href="#cassandra-storage-backend" title="Permalink to this headline">¶</a></h3>
<p>Eventuate also provides an event log actor implementation that writes events to a Cassandra cluster. That actor can be created with:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">akka.actor.ActorSystem</span>
<span class="k">import</span> <span class="nn">com.rbmhtechnology.eventuate.log.cassandra.CassandraEventLog</span>

<span class="k">val</span> <span class="n">system</span><span class="k">:</span> <span class="kt">ActorSystem</span> <span class="o">=</span> <span class="c1">// ...</span>
<span class="k">val</span> <span class="n">log</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">CassandraEventLog</span><span class="o">.</span><span class="n">props</span><span class="o">(</span><span class="n">logId</span> <span class="k">=</span> <span class="s">&quot;L1&quot;</span><span class="o">))</span>
</pre></div>
</div>
<p>With default configuration settings the event log actor connects to a Cassandra node at <code class="docutils literal"><span class="pre">127.0.0.1:9042</span></code>. This can be customized with</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">eventuate</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">cassandra</span><span class="o">.</span><span class="n">contact</span><span class="o">-</span><span class="n">points</span> <span class="k">=</span> <span class="o">[</span><span class="kt">host1</span><span class="o">[</span><span class="kt">:port1</span><span class="o">]</span>, <span class="kt">host2</span><span class="o">[</span><span class="kt">:port2</span><span class="o">]</span>, <span class="kt">...</span><span class="o">]</span>
</pre></div>
</div>
<p>Ports are optional and default to <code class="docutils literal"><span class="pre">9042</span></code> according to</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">eventuate</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">cassandra</span><span class="o">.</span><span class="n">default</span><span class="o">-</span><span class="n">port</span> <span class="k">=</span> <span class="mi">9042</span>
</pre></div>
</div>
<p>If Cassandra requires authentication, the default username used by Eventuate is <code class="docutils literal"><span class="pre">cassandra</span></code>, the default password is <code class="docutils literal"><span class="pre">cassandra</span></code> (which corresponds to Cassandra&#8217;s default superuser). This can be changed with</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">eventuate</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">cassandra</span><span class="o">.</span><span class="n">username</span> <span class="k">=</span> <span class="s">&quot;my-username&quot;</span>
<span class="n">eventuate</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">cassandra</span><span class="o">.</span><span class="n">password</span> <span class="k">=</span> <span class="s">&quot;my-password&quot;</span>
</pre></div>
</div>
<p>Further details are described in the API docs of the <a class="reference external" href="../latest/api/index.html#com.rbmhtechnology.eventuate.log.cassandra.Cassandra">Cassandra extension</a> and the <a class="reference external" href="../latest/api/index.html#com.rbmhtechnology.eventuate.log.cassandra.CassandraEventLog">CassandraEventLog</a> actor. A complete reference of <code class="docutils literal"><span class="pre">eventuate.log.cassandra</span></code> configuration options is given in section <a class="reference internal" href="configuration.html#configuration"><span>Configuration</span></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Eventuate requires Cassandra version 2.1 or higher.</p>
</div>
<div class="section" id="cassandra-development-cluster">
<h4>Cassandra development cluster<a class="headerlink" href="#cassandra-development-cluster" title="Permalink to this headline">¶</a></h4>
<p>For running automated integration tests, Eventuate uses <a class="reference external" href="https://github.com/jsevellec/cassandra-unit/wiki">cassandra-unit</a> for starting an embedded Cassandra instance. So there’s no need for a separate Cassandra installation when running the tests. If you want to have a separate Cassandra installation in your development environment for testing your application, either follow the installation instructions in the Cassandra <a class="reference external" href="https://wiki.apache.org/cassandra/GettingStarted">Getting Started</a> guide or start Cassandra in one or more Docker containers as described here. It is assumed that you have <a class="reference external" href="https://www.docker.com/">Docker</a> installed in your development environment.</p>
<p>For starting a single Cassandra instance run<a class="footnote-reference" href="#id11" id="id6">[2]</a></p>
<div class="highlight-scala"><div class="highlight"><pre>docker run --name cassandra-1 -p 9042:9042 -d cassandra:2.1.6
</pre></div>
</div>
<p>On Linux, you are now ready to access Cassandra on <code class="docutils literal"><span class="pre">127.0.0.1:9042</span></code>. On Mac OS X, the Docker host is running in the <a class="reference external" href="http://boot2docker.io/">boot2docker</a> virtual machine whose IP address can be obtained with</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">boot2docker</span> <span class="n">ip</span>
</pre></div>
</div>
<p>Assuming this returns <code class="docutils literal"><span class="pre">192.168.59.103</span></code> you can access Cassandra on <code class="docutils literal"><span class="pre">192.168.59.103:9042</span></code>. The container can be stopped with</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">docker</span> <span class="n">stop</span> <span class="n">cassandra</span><span class="o">-</span><span class="mi">1</span>
</pre></div>
</div>
<p>and started again with</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">docker</span> <span class="n">start</span> <span class="n">cassandra</span><span class="o">-</span><span class="mi">1</span>
</pre></div>
</div>
<p>This will keep previously stored data. For removing the container including all stored data run</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">docker</span> <span class="n">rm</span> <span class="n">cassandra</span><span class="o">-</span><span class="mi">1</span>
</pre></div>
</div>
<p>For running a three node Cassandra cluster start two additional containers with</p>
<div class="highlight-scala"><div class="highlight"><pre>docker run --name cassandra-2 -p 9043:9042 -d -e CASSANDRA_SEEDS=&quot;$(docker inspect --format=&#39;{{ .NetworkSettings.IPAddress }}&#39; cassandra-1)&quot; cassandra:2.1.6
docker run --name cassandra-3 -p 9044:9042 -d -e CASSANDRA_SEEDS=&quot;$(docker inspect --format=&#39;{{ .NetworkSettings.IPAddress }}&#39; cassandra-1)&quot; cassandra:2.1.6
</pre></div>
</div>
<p>For connecting to this cluster from Eventuate, add</p>
<div class="highlight-scala"><div class="highlight"><pre>log.cassandra.contact-points = [“&lt;hostname&gt;:9042&quot;, &quot;&lt;hostname&gt;:9043&quot;, &quot;&lt;hostname&gt;:9044&quot;]
</pre></div>
</div>
<p>to <code class="docutils literal"><span class="pre">application.conf</span></code> where <code class="docutils literal"><span class="pre">&lt;hostname&gt;</span></code> must be replaced with the proper IP address as described above.</p>
</div>
</div>
</div>
<div class="section" id="replicated-event-log">
<span id="id7"></span><h2>Replicated event log<a class="headerlink" href="#replicated-event-log" title="Permalink to this headline">¶</a></h2>
<p>Local event logs from different locations can be connected for event replication. For example, when connecting a local event log <code class="docutils literal"><span class="pre">L1</span></code> at location <code class="docutils literal"><span class="pre">1</span></code> with a local event log <code class="docutils literal"><span class="pre">L2</span></code> at location <code class="docutils literal"><span class="pre">2</span></code>, then the events written to <code class="docutils literal"><span class="pre">L1</span></code> are asynchronously replicated to location <code class="docutils literal"><span class="pre">2</span></code> and merged into to <code class="docutils literal"><span class="pre">L2</span></code>. Also, events written to <code class="docutils literal"><span class="pre">L2</span></code> are asynchronously replicated to location <code class="docutils literal"><span class="pre">1</span></code> and merged into <code class="docutils literal"><span class="pre">L1</span></code>. Merging preserves the causal ordering of events which is tracked with vector timestamps. Setting up a bi-directional replication connection between local event logs <code class="docutils literal"><span class="pre">L1</span></code> and <code class="docutils literal"><span class="pre">L2</span></code> yields a <em>replicated event log</em> <code class="docutils literal"><span class="pre">L</span></code>:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">L1</span> <span class="o">----</span> <span class="n">L2</span>
</pre></div>
</div>
<p>Since events can be written concurrently at different locations, the local event logs are likely to have a different total order of events at different locations. The causal order of events, however, is consistent across locations: if event <code class="docutils literal"><span class="pre">e1</span></code> causes event <code class="docutils literal"><span class="pre">e2</span></code> (i.e. <code class="docutils literal"><span class="pre">e1</span></code> happened before <code class="docutils literal"><span class="pre">e2</span></code>) then the offset of <code class="docutils literal"><span class="pre">e1</span></code> is less than the offset of <code class="docutils literal"><span class="pre">e2</span></code> at all locations. The offset of an event in a local event log is its local sequence number. On the other hand, if <code class="docutils literal"><span class="pre">e1</span></code> and <code class="docutils literal"><span class="pre">e2</span></code> are written concurrently, their relative order in a local event log is not defined: the offset of <code class="docutils literal"><span class="pre">e1</span></code> can be less than that of <code class="docutils literal"><span class="pre">e2</span></code> at one location but greater than that of <code class="docutils literal"><span class="pre">e2</span></code> at another location.</p>
<p>A replicated event log can also be set up for more than two locations (see also current <a class="reference internal" href="../current-limitations.html#current-limitations"><span>Current limitations</span></a>). Here event log <code class="docutils literal"><span class="pre">L</span></code> is replicated across locations <code class="docutils literal"><span class="pre">1</span></code> - <code class="docutils literal"><span class="pre">6</span></code>:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">L1</span>           <span class="n">L5</span>
  <span class="o">\</span>         <span class="o">/</span>
   <span class="n">L2</span> <span class="o">---</span> <span class="n">L4</span>
  <span class="o">/</span>         <span class="o">\</span>
<span class="n">L3</span>           <span class="n">L6</span>
</pre></div>
</div>
<p>A location may also have several local event logs that can be replicated independently of each other. The following example shows three replicated events logs <code class="docutils literal"><span class="pre">L</span></code>, <code class="docutils literal"><span class="pre">M</span></code> and <code class="docutils literal"><span class="pre">N</span></code> that are replicated across locations <code class="docutils literal"><span class="pre">1</span></code> and <code class="docutils literal"><span class="pre">2</span></code>:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">L1</span> <span class="o">----</span> <span class="n">L2</span>
<span class="n">M1</span> <span class="o">----</span> <span class="n">M2</span>
<span class="n">N1</span> <span class="o">----</span> <span class="n">N2</span>
</pre></div>
</div>
<p>The distribution of <code class="docutils literal"><span class="pre">L</span></code>, <code class="docutils literal"><span class="pre">M</span></code> and <code class="docutils literal"><span class="pre">N</span></code> across locations may also differ:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">L1</span> <span class="o">----</span> <span class="n">L2</span>
<span class="n">M1</span> <span class="o">----</span> <span class="n">M2</span> <span class="o">---</span> <span class="n">M3</span>
        <span class="n">N2</span> <span class="o">---</span> <span class="n">N3</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Event replication is reliable and fault-tolerant. Replicated events are also guaranteed to be written <em>exactly-once</em> to a target log. This is possible because replication progress metadata are stored along with replicated events in the target log. This allows a replication target to reliably detect and ignore duplicates. Event-sourced actors and views can therefore rely on receiving a de-duplicated event stream. Event replication can also recover from crashes of source and target locations i.e. event replication automatically resumes when a crashed location recovers.</p>
</div>
<div class="section" id="replication-endpoints">
<h3>Replication endpoints<a class="headerlink" href="#replication-endpoints" title="Permalink to this headline">¶</a></h3>
<p>Events are replicated over <em>replication connections</em> that are established between <em>replication endpoints</em>. A location may have one or more replication endpoints and a replication endpoint can manage one or more event logs. The following examples assume two locations <code class="docutils literal"><span class="pre">1</span></code> and <code class="docutils literal"><span class="pre">2</span></code> and two replicated event logs <code class="docutils literal"><span class="pre">L</span></code> and <code class="docutils literal"><span class="pre">M</span></code>:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">L1</span> <span class="o">----</span> <span class="n">L2</span>
<span class="n">M1</span> <span class="o">----</span> <span class="n">M2</span>
</pre></div>
</div>
<p>Each location has a <code class="docutils literal"><span class="pre">ReplicationEndpoint</span></code> that manages the local event logs. Replication endpoints communicate with each other via <a class="reference external" href="http://doc.akka.io/docs/akka/2.3.9/scala/remoting.html">Akka Remoting</a> which must be enabled by all locations in their <code class="docutils literal"><span class="pre">application.conf</span></code>:</p>
<div class="highlight-scala"><div class="highlight"><pre>akka.actor.provider = &quot;akka.remote.RemoteActorRefProvider&quot;
akka.remote.enabled-transports = [&quot;akka.remote.netty.tcp&quot;]
</pre></div>
</div>
<p>The network address of the replication endpoint at location <code class="docutils literal"><span class="pre">1</span></code> is:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">netty</span><span class="o">.</span><span class="n">tcp</span><span class="o">.</span><span class="n">hostname</span> <span class="k">=</span> <span class="s">&quot;127.0.0.1&quot;</span>
<span class="n">akka</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">netty</span><span class="o">.</span><span class="n">tcp</span><span class="o">.</span><span class="n">port</span><span class="k">=</span><span class="mi">2552</span>
</pre></div>
</div>
<p>At location <code class="docutils literal"><span class="pre">2</span></code> it is:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">netty</span><span class="o">.</span><span class="n">tcp</span><span class="o">.</span><span class="n">hostname</span> <span class="k">=</span> <span class="s">&quot;127.0.0.1&quot;</span>
<span class="n">akka</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">netty</span><span class="o">.</span><span class="n">tcp</span><span class="o">.</span><span class="n">port</span><span class="k">=</span><span class="mi">2553</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">ReplicationEndpoint</span></code> at location <code class="docutils literal"><span class="pre">1</span></code> can be created programmatically with:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">com.rbmhtechnology.eventuate._</span>
<span class="k">import</span> <span class="nn">com.rbmhtechnology.eventuate.log.leveldb.LeveldbEventLog</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="n">system</span><span class="k">:</span> <span class="kt">ActorSystem</span> <span class="o">=</span>
  <span class="nc">ActorSystem</span><span class="o">(</span><span class="nc">ReplicationConnection</span><span class="o">.</span><span class="nc">DefaultRemoteSystemName</span><span class="o">)</span>

<span class="k">val</span> <span class="n">endpoint1</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ReplicationEndpoint</span><span class="o">(</span><span class="n">id</span> <span class="k">=</span> <span class="s">&quot;1&quot;</span><span class="o">,</span> <span class="n">logNames</span> <span class="k">=</span> <span class="nc">Set</span><span class="o">(</span><span class="s">&quot;L&quot;</span><span class="o">,</span> <span class="s">&quot;M&quot;</span><span class="o">),</span>
  <span class="n">logFactory</span> <span class="k">=</span> <span class="n">logId</span> <span class="k">=&gt;</span> <span class="nc">LeveldbEventLog</span><span class="o">.</span><span class="n">props</span><span class="o">(</span><span class="n">logId</span><span class="o">),</span>
  <span class="n">connections</span> <span class="k">=</span> <span class="nc">Set</span><span class="o">(</span><span class="nc">ReplicationConnection</span><span class="o">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="o">,</span> <span class="mi">2553</span><span class="o">)))</span>
</pre></div>
</div>
<p>A <code class="docutils literal"><span class="pre">ReplicationEndpoint</span></code> must have a global unique <code class="docutils literal"><span class="pre">id</span></code>. Here, the location identifier <code class="docutils literal"><span class="pre">1</span></code> is used to identify the replication endpoint. Furthermore, the <code class="docutils literal"><span class="pre">logNames</span></code><a class="footnote-reference" href="#id12" id="id8">[3]</a> of the replicated event logs (<code class="docutils literal"><span class="pre">L</span></code> and <code class="docutils literal"><span class="pre">M</span></code>) and a <code class="docutils literal"><span class="pre">logFactory</span></code> for creating the local event log actors are provided. Input parameter of the <code class="docutils literal"><span class="pre">logFactory</span></code> is a unique <code class="docutils literal"><span class="pre">logId</span></code> that is generated by the replication endpoint from a combination of the provided <code class="docutils literal"><span class="pre">logNames</span></code> and the endpoint <code class="docutils literal"><span class="pre">id</span></code>.</p>
<p>The last <code class="docutils literal"><span class="pre">ReplicationEndpoint</span></code> constructor parameter is a set of <code class="docutils literal"><span class="pre">ReplicationConnection</span></code>s. Here, it is a single replication connection that connects to the remote replication endpoint at location <code class="docutils literal"><span class="pre">2</span></code>. With this replication connection, events are replicated from location <code class="docutils literal"><span class="pre">2</span></code> to location <code class="docutils literal"><span class="pre">1</span></code>. For replicating events in the other direction, a corresponding <code class="docutils literal"><span class="pre">ReplicationEndpoint</span></code> and <code class="docutils literal"><span class="pre">ReplicationConnection</span></code> must be set up at location <code class="docutils literal"><span class="pre">2</span></code>:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">endpoint2</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ReplicationEndpoint</span><span class="o">(</span><span class="n">id</span> <span class="k">=</span> <span class="s">&quot;2&quot;</span><span class="o">,</span> <span class="n">logNames</span> <span class="k">=</span> <span class="nc">Set</span><span class="o">(</span><span class="s">&quot;L&quot;</span><span class="o">,</span> <span class="s">&quot;M&quot;</span><span class="o">),</span>
  <span class="n">logFactory</span> <span class="k">=</span> <span class="n">logId</span> <span class="k">=&gt;</span> <span class="nc">LeveldbEventLog</span><span class="o">.</span><span class="n">props</span><span class="o">(</span><span class="n">logId</span><span class="o">),</span>
  <span class="n">connections</span> <span class="k">=</span> <span class="nc">Set</span><span class="o">(</span><span class="nc">ReplicationConnection</span><span class="o">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="o">,</span> <span class="mi">2552</span><span class="o">)))</span>
</pre></div>
</div>
<p>The event log actors that are created by a <code class="docutils literal"><span class="pre">ReplicationEndpoint</span></code> can be obtained from its <code class="docutils literal"><span class="pre">logs</span></code> map. Map keys are the event log names, map values the event log <code class="docutils literal"><span class="pre">ActorRef</span></code>s:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">l1</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span> <span class="n">endpoint1</span><span class="o">.</span><span class="n">logs</span><span class="o">(</span><span class="s">&quot;L&quot;</span><span class="o">)</span>
<span class="k">val</span> <span class="n">m1</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span> <span class="n">endpoint1</span><span class="o">.</span><span class="n">logs</span><span class="o">(</span><span class="s">&quot;M&quot;</span><span class="o">)</span>
</pre></div>
</div>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">Further <code class="docutils literal"><span class="pre">ReplicationEndpoint</span></code> creation options are described in the API documentation of the <a class="reference external" href="../latest/api/index.html#com.rbmhtechnology.eventuate.ReplicationEndpoint$">ReplicationEndpoint</a> and <a class="reference external" href="../latest/api/index.html#com.rbmhtechnology.eventuate.ReplicationConnection$">ReplicationConnection</a> companion objects. A complete reference of configuration options is given in section <a class="reference internal" href="configuration.html#configuration"><span>Configuration</span></a>.</p>
</div>
</div>
<div class="section" id="replication-filters">
<span id="id9"></span><h3>Replication filters<a class="headerlink" href="#replication-filters" title="Permalink to this headline">¶</a></h3>
<p>By default, all events are replicated. Applications may provide <code class="docutils literal"><span class="pre">ReplicationFilter</span></code>s to limit replication to a subset of events. A custom replication filter can be defined, by extending <a class="reference external" href="../latest/api/index.html#com.rbmhtechnology.eventuate.ReplicationFilter">ReplicationFilter</a> and implementing a filter predicate (method <code class="docutils literal"><span class="pre">apply</span></code>). For example, the following replication filter selects <a class="reference external" href="../latest/api/index.html#com.rbmhtechnology.eventuate.DurableEvent">DurableEvent</a>s with a matching <code class="docutils literal"><span class="pre">emitterAggregateId</span></code>:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">com.rbmhtechnology.eventuate._</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">AggregateIdFilter</span><span class="o">(</span><span class="n">aggregateId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">ReplicationFilter</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">event</span><span class="k">:</span> <span class="kt">DurableEvent</span><span class="o">)</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span>
    <span class="n">event</span><span class="o">.</span><span class="n">emitterAggregateId</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="n">aggregateId</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Replication filters can be defined per <code class="docutils literal"><span class="pre">ReplicationConnection</span></code> and event log name. They are transferred to a remote replication endpoint and applied there while reading from a <em>source event log</em> during replication. The following example configures a replication filter for log <code class="docutils literal"><span class="pre">L</span></code> so that only events with a defined <code class="docutils literal"><span class="pre">emitterAggregateId</span></code> of value <code class="docutils literal"><span class="pre">order-17</span></code> are replicated from the remote source log:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">filter1</span> <span class="k">=</span> <span class="nc">AggregateIdFilter</span><span class="o">(</span><span class="s">&quot;order-17&quot;</span><span class="o">)</span>
<span class="nc">ReplicationConnection</span><span class="o">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="o">,</span> <span class="mi">2553</span><span class="o">,</span> <span class="nc">Map</span><span class="o">(</span><span class="s">&quot;L&quot;</span> <span class="o">-&gt;</span> <span class="n">filter1</span><span class="o">))</span>
</pre></div>
</div>
<p>Replication filters can also be composed. The following creates a composed filter so that events with a defined <code class="docutils literal"><span class="pre">emitterAggregateId</span></code> of value <code class="docutils literal"><span class="pre">order-17</span></code> or <code class="docutils literal"><span class="pre">order-19</span></code> are replicated:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">filter2</span> <span class="k">=</span> <span class="n">filter1</span> <span class="n">or</span> <span class="nc">AggregateIdFilter</span><span class="o">(</span><span class="s">&quot;order-19&quot;</span><span class="o">)</span>
<span class="nc">ReplicationConnection</span><span class="o">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="o">,</span> <span class="mi">2553</span><span class="o">,</span> <span class="nc">Map</span><span class="o">(</span><span class="s">&quot;M&quot;</span> <span class="o">-&gt;</span> <span class="n">filter2</span><span class="o">))</span>
</pre></div>
</div>
<p>For the definition of filter logic based on application-defined events, replication filters should use the <code class="docutils literal"><span class="pre">payload</span></code> field of <code class="docutils literal"><span class="pre">DurableEvent</span></code>.</p>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">Serialization of replication filters can be customized as described in section <a class="reference internal" href="event-sourcing.html#replication-filter-serialization"><span>Custom replication filter serialization</span></a>.</p>
</div>
</div>
<div class="section" id="batch-replication">
<h3>Batch replication<a class="headerlink" href="#batch-replication" title="Permalink to this headline">¶</a></h3>
<p>Events are replicated in batches. The maximum number of events per batch can be configured with</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">eventuate</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">replication</span><span class="o">.</span><span class="n">batch</span><span class="o">-</span><span class="n">size</span><span class="o">-</span><span class="n">max</span> <span class="k">=</span> <span class="mi">512</span>
</pre></div>
</div>
<p>Applications that increase the maximum batch size and/or store rather large events should also increase</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">netty</span><span class="o">.</span><span class="n">tcp</span><span class="o">.</span><span class="n">maximum</span><span class="o">-</span><span class="n">frame</span><span class="o">-</span><span class="n">size</span> <span class="k">=</span> <span class="mi">128000</span><span class="n">b</span>
</pre></div>
</div>
<p>otherwise, replication will fail.</p>
</div>
<div class="section" id="failure-detection">
<h3>Failure detection<a class="headerlink" href="#failure-detection" title="Permalink to this headline">¶</a></h3>
<p>Replication endpoints can notify applications about availability and un-availability of remote event logs. They can become unavailable either during a network partition, a crash or a scheduled downtime of their hosting application. A local replication endpoint publishes</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">Available(endpointId:</span> <span class="pre">String,</span> <span class="pre">logName:</span> <span class="pre">String)</span></code> messages to the local <code class="docutils literal"><span class="pre">ActorSystem</span></code>s <a class="reference external" href="http://doc.akka.io/docs/akka/2.3.9/scala/event-bus.html#event-stream">event stream</a> if the remote replication endpoint is available, and</li>
<li><code class="docutils literal"><span class="pre">Unavailable(endpointId:</span> <span class="pre">String,</span> <span class="pre">logName:</span> <span class="pre">String)</span></code> messages to the local <code class="docutils literal"><span class="pre">ActorSystem</span></code>s <a class="reference external" href="http://doc.akka.io/docs/akka/2.3.9/scala/event-bus.html#event-stream">event stream</a> if the remote replication endpoint is unavailable</li>
</ul>
<p>Both messages are defined in <a class="reference external" href="../latest/api/index.html#com.rbmhtechnology.eventuate.ReplicationEndpoint$">ReplicationEndpoint</a>. Their <code class="docutils literal"><span class="pre">endpointId</span></code> parameter is the id of the remote replication endpoint, the <code class="docutils literal"><span class="pre">logName</span></code> parameter is the name of an event log that is managed by the remote endpoint. The failure detection limit can be configured with:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">eventuate</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">replication</span><span class="o">.</span><span class="n">failure</span><span class="o">-</span><span class="n">detection</span><span class="o">-</span><span class="n">limit</span> <span class="k">=</span> <span class="mi">60</span><span class="n">s</span>
</pre></div>
</div>
<p>It instructs the failure detector to publish an <code class="docutils literal"><span class="pre">Unavailable</span></code> message if there is no heartbeat from the remote replication endpoint within 60 seconds. <code class="docutils literal"><span class="pre">Available</span></code> and <code class="docutils literal"><span class="pre">Unavailable</span></code> messages are published periodically at intervals of <code class="docutils literal"><span class="pre">eventuate.log.replication.failure-detection-limit</span></code>.</p>
<table class="docutils footnote" frame="void" id="id10" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[1]</a></td><td>A location can be a whole data center, a node within a data center or even a process on a single node, for example.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id11" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[2]</a></td><td>When running the command for the first time, it will download all required Docker images which may take a while.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id12" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[3]</a></td><td>Log names must be unique per replication endpoint. Replication connections are only established between logs of the same name.</td></tr>
</tbody>
</table>
</div>
</div>
</div>


          </div>
		    
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="event-sourcing.html" class="float-right" title="Event-sourced actors">Next</a>
      
      
        <a href="api-docs.html" title="API docs">Previous</a>
      
    </div>
  
        </div>
	  </div>
    <div class="wrapper-footer">
<footer>
  <div role="contentinfo">
    <p>
        &copy; Copyright 2015 Red Bull Media House.  | <a href="http://rbmhtechnology.github.io/imprint" target="_blank">Imprint</a> | <a href="http://rbmhtechnology.github.io/termsconditions" target="_blank">Terms &amp; Conditions</a> | <a href="http://rbmhtechnology.github.io/dataprivacypolicy" target="_blank">Data Privacy Policy</a> 
    </p>
  </div>

</footer>
</div>
      
    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.3-SNAPSHOT',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>