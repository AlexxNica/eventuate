

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Event-sourced actors &mdash; Eventuate</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Eventuate" href="../index.html"/>
        <link rel="up" title="Reference" href="../reference.html"/>
        <link rel="next" title="Configuration" href="configuration.html"/>
        <link rel="prev" title="Event log" href="event-log.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

  
	<script src="//fonts.redbullmediahouse.com/snv5vzo.js"></script>
	<script>try{Typekit.load();}catch(e){}</script>
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        
          
          <a href="../index.html"><img src="../_static/RedBullMediaHouse-dark.png" class="logo" /></a>
        
        
		
<div role="search" class="searchbox">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search Eventuate" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
	
        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">Architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#event-logs">Event logs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#event-sourced-actors">Event-sourced actors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#event-sourced-views">Event-sourced views</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#event-sourced-processors">Event-sourced processors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#operation-based-crdts">Operation-based CRDTs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#vector-clocks">Vector clocks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#batching">Batching</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#adapters">Adapters</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../download.html">Download</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../download.html#binaries">Binaries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../download.html#sources">Sources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user-guide.html">User guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user-guide.html#event-sourced-actors">Event-sourced actors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide.html#detecting-concurrent-updates">Detecting concurrent updates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide.html#tracking-conflicting-versions">Tracking conflicting versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide.html#resolving-conflicting-versions">Resolving conflicting versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide.html#operation-based-crdts">Operation-based CRDTs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide.html#event-sourced-views">Event-sourced views</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guide.html#conditional-commands">Conditional commands</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../reference.html">Reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="api-docs.html">API docs</a></li>
<li class="toctree-l2"><a class="reference internal" href="event-log.html">Event log</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Event-sourced actors</a></li>
<li class="toctree-l2"><a class="reference internal" href="#event-sourced-views">Event-sourced views</a></li>
<li class="toctree-l2"><a class="reference internal" href="#state-recovery">State recovery</a></li>
<li class="toctree-l2"><a class="reference internal" href="#snapshots">Snapshots</a></li>
<li class="toctree-l2"><a class="reference internal" href="#event-routing">Event routing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#reliable-delivery">Reliable delivery</a></li>
<li class="toctree-l2"><a class="reference internal" href="#custom-serialization">Custom serialization</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html">Configuration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../developers.html">Developers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../developers.html#contributing-to-eventuate">Contributing to Eventuate</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developers.html#building-eventuate">Building Eventuate</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../project.html">Project</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../project.html#community">Community</a></li>
<li class="toctree-l2"><a class="reference internal" href="../project.html#license">License</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../articles.html">Articles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">FAQ</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../faq.html#how-does-eventuate-compare-to-akka-persistence">How does Eventuate compare to Akka Persistence?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../example-application.html">Example application</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../example-application.html#domain">Domain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example-application.html#replication">Replication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example-application.html#interface">Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../example-application.html#running">Running</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../current-limitations.html">Current limitations</a></li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html"><img src="../_static/RedBullMediaHouse-light.png" class="logo" /></a>
      </nav>
 
      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li>
		<a href="../index.html"><h2><span class="breadcrumbicon rbicons topfront"><i class="fa fa-calendar"></i></span>Eventuate</h2></a> &raquo;
	</li>
    
    <li><a href="../reference.html">Reference</a> &raquo;</li>
    
    <li>Event-sourced actors</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="event-sourced-actors">
<h1>Event-sourced actors<a class="headerlink" href="#event-sourced-actors" title="Permalink to this headline">¶</a></h1>
<p>An introduction to event-sourced actors is already given in section <a class="reference internal" href="../architecture.html#architecture"><span>Architecture</span></a> and the <a class="reference internal" href="../user-guide.html#user-guide"><span>User guide</span></a>. Applications use event-sourced actors for writing events to an event log and for maintaining state on the command side (C) of a <a class="reference external" href="http://martinfowler.com/bliki/CQRS.html">CQRS</a> architecture. Event-sourced actors distinguish command processing from event processing. They must extend the <a class="reference external" href="../latest/api/index.html#com.rbmhtechnology.eventuate.EventsourcedActor">EventsourcedActor</a> trait and implement a <a class="reference internal" href="#command-handler"><span>Command handler</span></a> and an <a class="reference internal" href="#event-handler"><span>Event handler</span></a>.</p>
<div class="section" id="command-handler">
<span id="id1"></span><h2>Command handler<a class="headerlink" href="#command-handler" title="Permalink to this headline">¶</a></h2>
<p>A command handler is partial function of type <code class="docutils literal"><span class="pre">PartialFunction[Any,</span> <span class="pre">Unit]</span></code> for which a type alias <code class="docutils literal"><span class="pre">Receive</span></code> exists. It can be defined by implementing <code class="docutils literal"><span class="pre">onCommand</span></code>:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">scala.util._</span>
<span class="k">import</span> <span class="nn">akka.actor._</span>
<span class="k">import</span> <span class="nn">com.rbmhtechnology.eventuate.EventsourcedActor</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">ExampleEvent</span><span class="o">(</span><span class="n">data</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">ExampleCommand</span><span class="o">(</span><span class="n">data</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">ExampleCommandSuccess</span><span class="o">(</span><span class="n">data</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">ExampleCommandFailure</span><span class="o">(</span><span class="n">cause</span><span class="k">:</span> <span class="kt">Throwable</span><span class="o">)</span>

<span class="k">class</span> <span class="nc">ExampleActor</span><span class="o">(</span><span class="k">override</span> <span class="k">val</span> <span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
                   <span class="k">override</span> <span class="k">val</span> <span class="n">eventLog</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">EventsourcedActor</span> <span class="o">{</span>

  <span class="cm">/** Command handler */</span>
  <span class="k">override</span> <span class="k">val</span> <span class="n">onCommand</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">ExampleCommand</span><span class="o">(</span><span class="n">data</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="c1">// validate command</span>
      <span class="c1">// ...</span>

      <span class="c1">// derive event</span>
      <span class="k">val</span> <span class="n">event</span> <span class="k">=</span> <span class="nc">ExampleEvent</span><span class="o">(</span><span class="n">data</span><span class="o">)</span>
      <span class="c1">// persist event (asynchronously)</span>
      <span class="n">persist</span><span class="o">(</span><span class="n">event</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">Success</span><span class="o">(</span><span class="n">evt</span><span class="o">)</span> <span class="k">=&gt;</span>
          <span class="c1">// handle event</span>
          <span class="n">onEvent</span><span class="o">(</span><span class="n">evt</span><span class="o">)</span>
          <span class="c1">// success reply</span>
          <span class="n">sender</span><span class="o">()</span> <span class="o">!</span> <span class="nc">ExampleCommandSuccess</span><span class="o">(</span><span class="n">data</span><span class="o">)</span>
        <span class="k">case</span> <span class="nc">Failure</span><span class="o">(</span><span class="n">cause</span><span class="o">)</span> <span class="k">=&gt;</span>
          <span class="c1">// failure reply</span>
          <span class="n">sender</span><span class="o">()</span> <span class="o">!</span> <span class="nc">ExampleCommandFailure</span><span class="o">(</span><span class="n">cause</span><span class="o">)</span>
      <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">val</span> <span class="n">onEvent</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">ExampleEvent</span><span class="o">(</span><span class="n">data</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="c1">// ...</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Messages sent by an application to an event-sourced actor are received by its command handler. Usually, a command handler first validates a command, then derives one or more events from it, persists these events with <code class="docutils literal"><span class="pre">persist</span></code> and if persistence succeeds, calls the event handler<a class="footnote-reference" href="#id12" id="id2">[1]</a> and replies to the command sender. The <code class="docutils literal"><span class="pre">persist</span></code> method has the following signature<a class="footnote-reference" href="#id13" id="id3">[2]</a>:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">def</span> <span class="n">persist</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">event</span><span class="k">:</span> <span class="kt">A</span><span class="o">,</span> <span class="n">customDestinationAggregateIds</span><span class="k">:</span> <span class="kt">Set</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Set</span><span class="o">())(</span><span class="n">handler</span><span class="k">:</span> <span class="kt">Try</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=&gt;</span> <span class="nc">Unit</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">persist</span></code> method can be called one ore more times per received command. Calling <code class="docutils literal"><span class="pre">persist</span></code> does not immediately write events to the event log. Instead, events from <code class="docutils literal"><span class="pre">persist</span></code> calls are collected in memory and written to the event log when <code class="docutils literal"><span class="pre">onCommand</span></code> returns.</p>
<p>Events are written asynchronously to the event-sourced actor’s <code class="docutils literal"><span class="pre">eventLog</span></code>. After writing, the <code class="docutils literal"><span class="pre">eventLog</span></code> actor internally replies to the event-sourced actor with a success or failure message which is passed as argument to the persist <code class="docutils literal"><span class="pre">handler</span></code>.</p>
<p>The persist handler is called during a normal actor message dispatch. It can therefore safely access an actor’s internal state. The <code class="docutils literal"><span class="pre">sender()</span></code> reference of the original command sender is also preserved, so that a persist handler can reply to the initial command sender.</p>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">The <code class="docutils literal"><span class="pre">EventsourcedActor</span></code> trait also defines a <code class="docutils literal"><span class="pre">persistN</span></code> method. Refer to the <a class="reference external" href="../latest/api/index.html#com.rbmhtechnology.eventuate.EventsourcedActor">EventsourcedActor</a> API documentation for details.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A command handler should not modify persistent actor state i.e. state that is derived from events.</p>
</div>
<div class="section" id="handling-persistence-failures">
<h3>Handling persistence failures<a class="headerlink" href="#handling-persistence-failures" title="Permalink to this headline">¶</a></h3>
<p>Persistence may fail for several reasons. For example, event serialization or writing to the storage backend may fail, to mention only two examples. In general, a persist handler that is called with a <code class="docutils literal"><span class="pre">Failure</span></code> argument should not make any assumptions whether the corresponding event has been written or not. For example, an event could have been actually written to the storage backend but the ACK was lost which causes <code class="docutils literal"><span class="pre">persist</span></code> to complete with a failure.</p>
<p>One way to deal with this situation is to restart the event-sourced actor and inspect the recovered state whether that event has been processed or not. If it has been processed, the application can continue with the next command, otherwise it should re-send the failed command. This strategy avoids duplicates in the event log.</p>
<p>Duplicates are not an issue if state update operations executed by an event handler are idempotent. In this case, an application may simply re-send a failed command without restarting the event-sourced actor.</p>
</div>
</div>
<div class="section" id="state-synchronization">
<h2>State synchronization<a class="headerlink" href="#state-synchronization" title="Permalink to this headline">¶</a></h2>
<p>As explained in section <a class="reference internal" href="#command-handler"><span>Command handler</span></a>, events are persisted asynchronously. What happens if another command is sent to an event-sourced actor while persistence is in progress? This depends on the value of <code class="docutils literal"><span class="pre">stateSync</span></code>, a member of <code class="docutils literal"><span class="pre">EventsourcedActor</span></code> that can be overridden.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">def</span> <span class="n">stateSync</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="kc">true</span>
</pre></div>
</div>
<p>If <code class="docutils literal"><span class="pre">stateSync</span></code> is <code class="docutils literal"><span class="pre">true</span></code> (default), new commands are <a class="reference external" href="http://doc.akka.io/docs/akka/2.3.9/scala/actors.html#stash">stashed</a> while persistence is in progress. Consequently, new commands see actor state that is <em>in sync</em> with the events in the event log. A consequence is limited write throughput, because <a class="reference internal" href="../architecture.html#batching"><span>Batching</span></a> of write requests is not possible in this case<a class="footnote-reference" href="#id14" id="id4">[3]</a>. This setting is recommended for event-sourced actors that must validate commands against current state.</p>
<p>If <code class="docutils literal"><span class="pre">stateSync</span></code> is <code class="docutils literal"><span class="pre">false</span></code>, new commands are dispatched to <code class="docutils literal"><span class="pre">onCommand</span></code> immediately. Consequently, new commands may see stale actor state. The advantage is significantly higher write throughput as <a class="reference internal" href="../architecture.html#batching"><span>Batching</span></a> of write requests is possible. This setting is recommended for event-sourced actors that don’t need to validate commands against current state.</p>
<p>If a sender sends several update commands followed by a read command to an event-sourced actor that has <code class="docutils literal"><span class="pre">stateSync</span></code> set to <code class="docutils literal"><span class="pre">false</span></code>, the read command will probably not see the state change from the preceding update commands. To achieve read-your-write consistency, the command sender should wait for a reply from the last update command before sending the read command. The reply must of course be sent from within a <code class="docutils literal"><span class="pre">persist</span></code> handler.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">State synchronization settings only apply to a single actor instance. Events that are emitted concurrently by other actors and handled by that instance can arrive at any time and modify actor state. Anyway, concurrent events are not relevant for achieving read-your-write consistency and should be handled as described in the <a class="reference internal" href="../user-guide.html#user-guide"><span>User guide</span></a>.</p>
</div>
</div>
<div class="section" id="event-handler">
<span id="id5"></span><h2>Event handler<a class="headerlink" href="#event-handler" title="Permalink to this headline">¶</a></h2>
<p>An event handler is partial function of type <code class="docutils literal"><span class="pre">PartialFunction[Any,</span> <span class="pre">Unit]</span></code> for which a type alias <code class="docutils literal"><span class="pre">Receive</span></code> exists. It can be defined by implementing <code class="docutils literal"><span class="pre">onEvent</span></code>. An event handler handles persisted events by updating actor state from event details.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="cm">/** Event handler */</span>
<span class="k">override</span> <span class="k">val</span> <span class="n">onEvent</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">ExampleEvent</span><span class="o">(</span><span class="n">details</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="k">val</span> <span class="n">eventSequenceNr</span> <span class="k">=</span> <span class="n">lastSequenceNr</span>
    <span class="k">val</span> <span class="n">eventVectorTimestamp</span> <span class="k">=</span> <span class="n">lastVectorTimestamp</span>
    <span class="c1">// ...</span>

    <span class="c1">// update actor state</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Event metadata of the last handled event can be obtained with the <code class="docutils literal"><span class="pre">last*</span></code> methods defined by <code class="docutils literal"><span class="pre">EventsourcedActor</span></code>. For example, <code class="docutils literal"><span class="pre">lastSequenceNr</span></code> returns the event’s local sequence number, <code class="docutils literal"><span class="pre">lastVectorTimestamp</span></code> returns the event’s vector timestamp. A complete reference is given by the <a class="reference external" href="../latest/api/index.html#com.rbmhtechnology.eventuate.EventsourcedActor">EventsourcedActor</a> API documentation.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">An event handler should only update internal actor state without having further side-effects. An exception is <a class="reference internal" href="#reliable-delivery"><span>Reliable delivery</span></a> of messages.</p>
</div>
</div>
<div class="section" id="causality-tracking">
<h2>Causality tracking<a class="headerlink" href="#causality-tracking" title="Permalink to this headline">¶</a></h2>
<p>As described in section <a class="reference internal" href="../architecture.html#vector-clocks"><span>Vector clocks</span></a>, Eventuate’s causality tracking default can be formalized with <a class="reference external" href="https://github.com/RBMHTechnology/eventuate/issues/68">plausible clocks</a>. To achieve more fine-grained causality tracking, event-sourced actors can reserve their own entry in a vector clock. To reserve their own entry, concrete <code class="docutils literal"><span class="pre">EventsourcedActor</span></code>s must override the <code class="docutils literal"><span class="pre">sharedClockEntry</span></code> method to return <code class="docutils literal"><span class="pre">false</span></code>.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ExampleActor</span><span class="o">(</span><span class="k">override</span> <span class="k">val</span> <span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
                   <span class="k">override</span> <span class="k">val</span> <span class="n">eventLog</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">EventsourcedActor</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">sharedClockEntry</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="kc">false</span>

  <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The value of <code class="docutils literal"><span class="pre">sharedClockEntry</span></code> may also be instance-specific, if required.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ExampleActor</span><span class="o">(</span><span class="k">override</span> <span class="k">val</span> <span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
                   <span class="k">override</span> <span class="k">val</span> <span class="n">eventLog</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">,</span>
                   <span class="k">override</span> <span class="k">val</span> <span class="n">sharedClockEntry</span><span class="k">:</span> <span class="kt">Boolean</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">EventsourcedActor</span> <span class="o">{</span>

  <span class="c1">// ..</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="event-sourced-views">
<h1>Event-sourced views<a class="headerlink" href="#event-sourced-views" title="Permalink to this headline">¶</a></h1>
<p>An introduction to event-sourced views is already given in section <a class="reference internal" href="../architecture.html#architecture"><span>Architecture</span></a> and the <a class="reference internal" href="../user-guide.html#user-guide"><span>User guide</span></a>. Applications use event-sourced views for consuming events from an event log and for maintaining state on the query side (Q) of a <a class="reference external" href="http://martinfowler.com/bliki/CQRS.html">CQRS</a> architecture.</p>
<p>Like event-sourced actors, event-sourced views distinguish command processing from event processing. They must implement the <a class="reference external" href="../latest/api/index.html#com.rbmhtechnology.eventuate.EventsourcedView">EventsourcedView</a> trait. <code class="docutils literal"><span class="pre">EventsourcedView</span></code> is a functional subset of <code class="docutils literal"><span class="pre">EventsourcedActor</span></code> that cannot <code class="docutils literal"><span class="pre">persist</span></code> events.</p>
</div>
<div class="section" id="state-recovery">
<h1>State recovery<a class="headerlink" href="#state-recovery" title="Permalink to this headline">¶</a></h1>
<p>When an event-sourced actor or view is started or re-started, events are replayed to its <code class="docutils literal"><span class="pre">onEvent</span></code> handler so that internal state can be recovered<a class="footnote-reference" href="#id15" id="id6">[4]</a>. Event replay is initiated internally by sending a <code class="docutils literal"><span class="pre">Replay</span></code> message to the <code class="docutils literal"><span class="pre">eventLog</span></code> actor:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">private</span> <span class="k">def</span> <span class="n">replay</span><span class="o">(</span><span class="n">fromSequenceNr</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span>
  <span class="n">eventLog</span> <span class="o">!</span> <span class="nc">Replay</span><span class="o">(</span><span class="n">fromSequenceNr</span><span class="o">,</span> <span class="n">self</span><span class="o">,</span> <span class="n">aggregateId</span><span class="o">,</span> <span class="n">instanceId</span><span class="o">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">replay</span></code> method is defined by <a class="reference external" href="../latest/api/index.html#com.rbmhtechnology.eventuate.EventsourcedView">EventsourcedView</a> and automatically called when an <code class="docutils literal"><span class="pre">EventsourcedView</span></code> or <code class="docutils literal"><span class="pre">EventsourcedActor</span></code> is started or re-started.</p>
<p>Sending a <code class="docutils literal"><span class="pre">Replay</span></code> message automatically registers the sending actor at its event log, so that newly written events can be immediately routed to that actor. If the actor is stopped it is automatically de-registered.</p>
<p>While an event-sourced actor or view is recovering i.e. replaying messages, its <code class="docutils literal"><span class="pre">recovering</span></code> method returns <code class="docutils literal"><span class="pre">true</span></code>. If recovery successfully completes, its empty <code class="docutils literal"><span class="pre">onRecovered()</span></code> method is called which can be overridden by applications.</p>
<p>During recovery, new commands are <a class="reference external" href="http://doc.akka.io/docs/akka/2.3.9/scala/actors.html#stash">stashed</a> and dispatched to <code class="docutils literal"><span class="pre">onCommand</span></code> after recovery successfully completed. This ensures that new commands never see partially recovered state.</p>
</div>
<div class="section" id="snapshots">
<span id="id7"></span><h1>Snapshots<a class="headerlink" href="#snapshots" title="Permalink to this headline">¶</a></h1>
<p>Recovery times increase with the number of events that are replayed to event-sourced actors or views. They can be decreased by starting event replay from a previously saved snapshot of internal state rather than replaying events from scratch. Event-sourced actors and views can save snapshots by calling <code class="docutils literal"><span class="pre">save</span></code> within their command handler:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">scala.util._</span>
<span class="k">import</span> <span class="nn">akka.actor._</span>
<span class="k">import</span> <span class="nn">com.rbmhtechnology.eventuate.EventsourcedActor</span>
<span class="k">import</span> <span class="nn">com.rbmhtechnology.eventuate.SnapshotMetadata</span>

<span class="k">case</span> <span class="k">object</span> <span class="nc">Save</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">SaveSuccess</span><span class="o">(</span><span class="n">metadata</span><span class="k">:</span> <span class="kt">SnapshotMetadata</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">SaveFailure</span><span class="o">(</span><span class="n">cause</span><span class="k">:</span> <span class="kt">Throwable</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">ExampleState</span><span class="o">(</span><span class="n">components</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Vector</span><span class="o">.</span><span class="n">empty</span><span class="o">)</span>

<span class="k">class</span> <span class="nc">ExampleActor</span><span class="o">(</span><span class="k">override</span> <span class="k">val</span> <span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
                   <span class="k">override</span> <span class="k">val</span> <span class="n">eventLog</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">EventsourcedActor</span> <span class="o">{</span>

  <span class="k">var</span> <span class="n">state</span><span class="k">:</span> <span class="kt">ExampleState</span> <span class="o">=</span> <span class="nc">ExampleState</span><span class="o">()</span>

  <span class="k">override</span> <span class="k">val</span> <span class="n">onCommand</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Save</span> <span class="k">=&gt;</span>
      <span class="c1">// save snapshot of internal state (asynchronously)</span>
      <span class="n">save</span><span class="o">(</span><span class="n">state</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">Success</span><span class="o">(</span><span class="n">metadata</span><span class="o">)</span> <span class="k">=&gt;</span>
          <span class="c1">// success reply</span>
          <span class="n">sender</span><span class="o">()</span> <span class="o">!</span> <span class="nc">SaveSuccess</span><span class="o">(</span><span class="n">metadata</span><span class="o">)</span>
        <span class="k">case</span> <span class="nc">Failure</span><span class="o">(</span><span class="n">cause</span><span class="o">)</span> <span class="k">=&gt;</span>
          <span class="c1">// failure reply</span>
          <span class="n">sender</span><span class="o">()</span> <span class="o">!</span> <span class="nc">SaveFailure</span><span class="o">(</span><span class="n">cause</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="k">case</span> <span class="n">cmd</span> <span class="k">=&gt;</span> <span class="c1">// ...</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">val</span> <span class="n">onEvent</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">evt</span> <span class="k">=&gt;</span> <span class="c1">// update state ...</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Snapshots are saved asynchronously. On completion, a user-defined handler of type <code class="docutils literal"><span class="pre">Try[SnapshotMetadata]</span> <span class="pre">=&gt;</span> <span class="pre">Unit</span></code> is called. Like a <code class="docutils literal"><span class="pre">persist</span></code> handler, a <code class="docutils literal"><span class="pre">save</span></code> handler may also close over actor state and can reply to the command sender using the <code class="docutils literal"><span class="pre">sender()</span></code> reference.</p>
<p>An event-sourced actor that is <a class="reference internal" href="../user-guide.html#tracking-conflicting-versions"><span>Tracking conflicting versions</span></a> of application state can also save <code class="docutils literal"><span class="pre">ConcurrentVersions[A,</span> <span class="pre">B]</span></code> instances directly. One can even configure custom serializers for type parameter <code class="docutils literal"><span class="pre">A</span></code> as explained in section <a class="reference internal" href="#snapshot-serialization"><span>Custom snapshot serialization</span></a>.</p>
<p>During recovery, the latest snapshot saved by an event-sourced actor or view is loaded and can be handled with the <code class="docutils literal"><span class="pre">onSnapshot</span></code> handler. This handler should initialize internal actor state from the loaded snapshot:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ExampleActor</span><span class="o">(</span><span class="k">override</span> <span class="k">val</span> <span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
                   <span class="k">override</span> <span class="k">val</span> <span class="n">eventLog</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">EventsourcedActor</span> <span class="o">{</span>

  <span class="k">var</span> <span class="n">state</span><span class="k">:</span> <span class="kt">ExampleState</span> <span class="o">=</span> <span class="nc">ExampleState</span><span class="o">()</span>

  <span class="k">override</span> <span class="k">val</span> <span class="n">onCommand</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Save</span> <span class="k">=&gt;</span> <span class="c1">// ...</span>
    <span class="k">case</span> <span class="n">cmd</span> <span class="k">=&gt;</span> <span class="c1">// ...</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">val</span> <span class="n">onEvent</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">evt</span> <span class="k">=&gt;</span> <span class="c1">// update state ...</span>
  <span class="o">}</span>

  <span class="cm">/** Snapshot handler */</span>
  <span class="k">override</span> <span class="k">val</span> <span class="n">onSnapshot</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">s</span><span class="k">:</span> <span class="kt">ExampleState</span> <span class="o">=&gt;</span>
      <span class="c1">// initialize internal state from loaded snapshot</span>
      <span class="n">state</span> <span class="k">=</span> <span class="n">s</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>If <code class="docutils literal"><span class="pre">onSnapshot</span></code> is not defined at the loaded snapshot or not overridden at all, event replay starts from scratch. If <code class="docutils literal"><span class="pre">onSnapshot</span></code> is defined at the loaded snapshot, only events that are not covered by that snapshot will be replayed.</p>
<p>Event-sourced actors that implement <code class="docutils literal"><span class="pre">ConfirmedDelivery</span></code> for <a class="reference internal" href="#reliable-delivery"><span>Reliable delivery</span></a> automatically include unconfirmed messages into state snapshots. These are restored on recovery and re-delivered on recovery completion.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">State objects passed as argument to <code class="docutils literal"><span class="pre">save</span></code> should be <em>immutable objects</em>. If this is not the case, the caller is responsible for creating a defensive copy before passing it as argument to <code class="docutils literal"><span class="pre">save</span></code>.</p>
</div>
<div class="section" id="storage-locations">
<h2>Storage locations<a class="headerlink" href="#storage-locations" title="Permalink to this headline">¶</a></h2>
<p>Snapshots are currently stored in a directory that can be configured with</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">eventuate</span><span class="o">.</span><span class="n">snapshot</span><span class="o">.</span><span class="n">filesystem</span><span class="o">.</span><span class="n">dir</span> <span class="k">=</span> <span class="o">/</span><span class="n">my</span><span class="o">/</span><span class="n">storage</span><span class="o">/</span><span class="n">location</span>
</pre></div>
</div>
<p>in <code class="docutils literal"><span class="pre">application.conf</span></code>. The maximum number of stored snapshots per event-sourced actor or view can be configured with</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">eventuate</span><span class="o">.</span><span class="n">snapshot</span><span class="o">.</span><span class="n">filesystem</span><span class="o">.</span><span class="n">snapshots</span><span class="o">-</span><span class="n">per</span><span class="o">-</span><span class="n">emitter</span><span class="o">-</span><span class="n">max</span> <span class="k">=</span> <span class="mi">3</span>
</pre></div>
</div>
<p>If this number is exceeded, older snapshots are automatically deleted.</p>
</div>
</div>
<div class="section" id="event-routing">
<span id="id8"></span><h1>Event routing<a class="headerlink" href="#event-routing" title="Permalink to this headline">¶</a></h1>
<p>An event that is emitted by an event-sourced actor can be routed to other event-sourced actors and views if they share an <a class="reference internal" href="event-log.html#event-log"><span>Event log</span></a><a class="footnote-reference" href="#id16" id="id9">[5]</a> . The default event routing rules are:</p>
<ul class="simple">
<li>If an event-sourced actor or view has an undefined <code class="docutils literal"><span class="pre">aggregateId</span></code>, all events are routed to it. It may choose to handle only a subset of them though.</li>
<li>If an event-sourced actor or view has a defined <code class="docutils literal"><span class="pre">aggregateId</span></code>, only events emitted by event-sourced actors with the same <code class="docutils literal"><span class="pre">aggregateId</span></code> are routed to it.</li>
</ul>
<p>Routing destinations are defined during emission of an event and are persisted together with the event<a class="footnote-reference" href="#id17" id="id10">[6]</a>. This makes routing decisions repeatable during event replay and allows for routing rule changes without affecting past routing decisions. Applications can define additional routing destinations with the <code class="docutils literal"><span class="pre">customDestinationAggregateIds</span></code> parameter of <code class="docutils literal"><span class="pre">persist</span></code>:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">scala.util._</span>
<span class="k">import</span> <span class="nn">akka.actor._</span>
<span class="k">import</span> <span class="nn">com.rbmhtechnology.eventuate.EventsourcedActor</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">ExampleEvent</span><span class="o">(</span><span class="n">data</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">ExampleCommand</span><span class="o">(</span><span class="n">data</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

<span class="k">class</span> <span class="nc">ExampleActor</span><span class="o">(</span><span class="k">override</span> <span class="k">val</span> <span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
                   <span class="k">override</span> <span class="k">val</span> <span class="n">eventLog</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">EventsourcedActor</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">aggregateId</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="s">&quot;a1&quot;</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">val</span> <span class="n">onCommand</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">ExampleCommand</span><span class="o">(</span><span class="n">data</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">persist</span><span class="o">(</span><span class="nc">ExampleEvent</span><span class="o">(</span><span class="n">data</span><span class="o">),</span> <span class="n">customDestinationAggregateIds</span> <span class="k">=</span> <span class="nc">Set</span><span class="o">(</span><span class="s">&quot;a2&quot;</span><span class="o">,</span> <span class="s">&quot;a3&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">Success</span><span class="o">(</span><span class="n">evt</span><span class="o">)</span>   <span class="k">=&gt;</span> <span class="c1">// ...</span>
        <span class="k">case</span> <span class="nc">Failure</span><span class="o">(</span><span class="n">cause</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="c1">// ...</span>
      <span class="o">}</span>
  <span class="o">}</span>

  <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Here, <code class="docutils literal"><span class="pre">ExampleEvent</span></code> is routed to destinations with <code class="docutils literal"><span class="pre">aggregateId</span></code>s <code class="docutils literal"><span class="pre">Some(“a2”)</span></code> and <code class="docutils literal"><span class="pre">Some(“a3”)</span></code> in addition to the default routing destinations with <code class="docutils literal"><span class="pre">aggregateId</span></code>s <code class="docutils literal"><span class="pre">Some(“a1”)</span></code> and <code class="docutils literal"><span class="pre">None</span></code>.</p>
</div>
<div class="section" id="reliable-delivery">
<span id="id11"></span><h1>Reliable delivery<a class="headerlink" href="#reliable-delivery" title="Permalink to this headline">¶</a></h1>
<p>Reliable, event-based remote communication between event-sourced actors should be done via a <a class="reference internal" href="event-log.html#replicated-event-log"><span>Replicated event log</span></a>. For reliable communication with other services that cannot connect to a replicated event log, event-sourced actors should use the <a class="reference external" href="../latest/api/index.html#com.rbmhtechnology.eventuate.ConfirmedDelivery">ConfirmedDelivery</a> trait:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>
<span class="k">import</span> <span class="nn">scala.util._</span>
<span class="k">import</span> <span class="nn">akka.actor._</span>
<span class="k">import</span> <span class="nn">com.rbmhtechnology.eventuate.EventsourcedActor</span>
<span class="k">import</span> <span class="nn">com.rbmhtechnology.eventuate.ConfirmedDelivery</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">DeliverCommand</span><span class="o">(</span><span class="n">message</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">DeliverEvent</span><span class="o">(</span><span class="n">message</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Confirmation</span><span class="o">(</span><span class="n">deliveryId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">ConfirmationEvent</span><span class="o">(</span><span class="n">deliveryId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">ReliableMessage</span><span class="o">(</span><span class="n">deliveryId</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">message</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
<span class="k">case</span> <span class="k">object</span> <span class="nc">Redeliver</span>

<span class="k">class</span> <span class="nc">ExampleActor</span><span class="o">(</span><span class="n">destination</span><span class="k">:</span> <span class="kt">ActorPath</span><span class="o">,</span>
                   <span class="k">override</span> <span class="k">val</span> <span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
                   <span class="k">override</span> <span class="k">val</span> <span class="n">eventLog</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span>
  <span class="k">extends</span> <span class="nc">EventsourcedActor</span> <span class="k">with</span> <span class="nc">ConfirmedDelivery</span> <span class="o">{</span>

  <span class="k">import</span> <span class="nn">context.dispatcher</span>

  <span class="n">context</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">schedule</span><span class="o">(</span>
    <span class="n">initialDelay</span> <span class="k">=</span> <span class="mf">10.</span><span class="n">seconds</span><span class="o">,</span>
    <span class="n">interval</span> <span class="k">=</span> <span class="mf">5.</span><span class="n">seconds</span><span class="o">,</span>
    <span class="n">receiver</span> <span class="k">=</span> <span class="n">self</span><span class="o">,</span>
    <span class="n">message</span> <span class="k">=</span> <span class="nc">Redeliver</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">val</span> <span class="n">onCommand</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">DeliverCommand</span><span class="o">(</span><span class="n">message</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">persist</span><span class="o">(</span><span class="nc">DeliverEvent</span><span class="o">(</span><span class="n">message</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">Success</span><span class="o">(</span><span class="n">evt</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">onEvent</span><span class="o">(</span><span class="n">evt</span><span class="o">)</span>
        <span class="k">case</span> <span class="nc">Failure</span><span class="o">(</span><span class="n">err</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="c1">// ...</span>
      <span class="o">}</span>
    <span class="k">case</span> <span class="nc">Confirmation</span><span class="o">(</span><span class="n">deliveryId</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">persist</span><span class="o">(</span><span class="nc">ConfirmationEvent</span><span class="o">(</span><span class="n">deliveryId</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">Success</span><span class="o">(</span><span class="n">evt</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">onEvent</span><span class="o">(</span><span class="n">evt</span><span class="o">)</span>
        <span class="k">case</span> <span class="nc">Failure</span><span class="o">(</span><span class="n">err</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="c1">// ...</span>
      <span class="o">}</span>
    <span class="k">case</span> <span class="nc">Redeliver</span> <span class="k">=&gt;</span>
      <span class="n">redeliverUnconfirmed</span><span class="o">()</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">val</span> <span class="n">onEvent</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">DeliverEvent</span><span class="o">(</span><span class="n">message</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="k">val</span> <span class="n">deliveryId</span> <span class="k">=</span> <span class="n">lastSequenceNr</span><span class="o">.</span><span class="n">toString</span>
        <span class="n">deliver</span><span class="o">(</span><span class="n">deliveryId</span><span class="o">,</span> <span class="nc">ReliableMessage</span><span class="o">(</span><span class="n">deliveryId</span><span class="o">,</span> <span class="n">message</span><span class="o">),</span> <span class="n">destination</span><span class="o">)</span>
      <span class="k">case</span> <span class="nc">ConfirmationEvent</span><span class="o">(</span><span class="n">deliveryId</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="n">confirm</span><span class="o">(</span><span class="n">deliveryId</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">ConfirmedDelivery</span></code> supports the reliable delivery of messages to destinations by enabling applications to re-deliver messages until delivery is confirmed by destinations. In the example above, the reliable delivery of a message is initiated by sending a <code class="docutils literal"><span class="pre">DeliverCommand</span></code> to <code class="docutils literal"><span class="pre">ExampleActor</span></code>.</p>
<p>The generated <code class="docutils literal"><span class="pre">DeliverEvent</span></code> calls <code class="docutils literal"><span class="pre">deliver</span></code> to deliver a <code class="docutils literal"><span class="pre">ReliableMessage</span></code> to <code class="docutils literal"><span class="pre">destination</span></code>. The <code class="docutils literal"><span class="pre">deliveryId</span></code> is the correlation identifier for the delivery <code class="docutils literal"><span class="pre">Confirmation</span></code>. The <code class="docutils literal"><span class="pre">deliveryId</span></code> can be any application-defined id. Here, the event’s sequence number is used which can be obtained with <code class="docutils literal"><span class="pre">lastSequenceNumber</span></code>.</p>
<p>The destination confirms the delivery of the message by sending a <code class="docutils literal"><span class="pre">Confirmation</span></code> reply to the event-sourced actor from which the actor generates a <code class="docutils literal"><span class="pre">ConfirmationEvent</span></code>. When handling the event, message delivery can be confirmed by calling <code class="docutils literal"><span class="pre">confirm</span></code> with the <code class="docutils literal"><span class="pre">deliveryId</span></code> as argument.</p>
<p>When the actor is re-started, unconfirmed <code class="docutils literal"><span class="pre">ReliableMessage</span></code>s are automatically re-delivered to their <code class="docutils literal"><span class="pre">destination</span></code>s. The example actor additionally schedules <code class="docutils literal"><span class="pre">redeliverUnconfirmed</span></code> calls to periodically re-deliver unconfirmed messages. This is done within the actor’s command handler.</p>
</div>
<div class="section" id="custom-serialization">
<h1>Custom serialization<a class="headerlink" href="#custom-serialization" title="Permalink to this headline">¶</a></h1>
<div class="section" id="custom-event-serialization">
<span id="event-serialization"></span><h2>Custom event serialization<a class="headerlink" href="#custom-event-serialization" title="Permalink to this headline">¶</a></h2>
<p>Custom serializers for application-defined events can be configured with Akka&#8217;s <a class="reference external" href="http://doc.akka.io/docs/akka/2.3.9/scala/serialization.html">serialization extension</a>. For example, an application that wants to use a custom <code class="docutils literal"><span class="pre">MyDomainEventSerializer</span></code> for events of type <code class="docutils literal"><span class="pre">MyDomainEvent</span></code> (both defined in package <code class="docutils literal"><span class="pre">com.example</span></code>) should add the following configuration to <code class="docutils literal"><span class="pre">application.conf</span></code>:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">actor</span> <span class="o">{</span>
  <span class="n">serializers</span> <span class="o">{</span>
    <span class="n">domain</span><span class="o">-</span><span class="n">event</span><span class="o">-</span><span class="n">serializer</span> <span class="k">=</span> <span class="s">&quot;com.example.MyDomainEventSerializer&quot;</span>
  <span class="o">}</span>

  <span class="n">serialization</span><span class="o">-</span><span class="n">bindings</span> <span class="o">{</span>
    <span class="s">&quot;com.example.MyDomainEvent&quot;</span> <span class="k">=</span> <span class="n">domain</span><span class="o">-</span><span class="n">event</span><span class="o">-</span><span class="n">serializer</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">MyDomainEventSerializer</span></code> must extend Akka’s <a class="reference external" href="http://doc.akka.io/api/akka/2.3.9/#akka.serialization.Serializer">Serializer</a> trait. Please refer to Akka’s <a class="reference external" href="http://doc.akka.io/docs/akka/2.3.9/scala/serialization.html">serialization extension</a> documentation for further details.</p>
<p>Eventuate stores application-defined events as <code class="docutils literal"><span class="pre">payload</span></code> of <a class="reference external" href="../latest/api/index.html#com.rbmhtechnology.eventuate.DurableEvent">DurableEvent</a>s. <code class="docutils literal"><span class="pre">DurableEvent</span></code> itself is serialized with <a class="reference external" href="../latest/api/index.html#com.rbmhtechnology.eventuate.serializer.DurableEventSerializer">DurableEventSerializer</a>, a <a class="reference external" href="https://developers.google.com/protocol-buffers/">Protocol Buffers</a> based serializer that delegates <code class="docutils literal"><span class="pre">payload</span></code> serialization to a custom serializer. If no custom serializer is configured, Akka’s default serializer is used.</p>
</div>
<div class="section" id="custom-replication-filter-serialization">
<span id="replication-filter-serialization"></span><h2>Custom replication filter serialization<a class="headerlink" href="#custom-replication-filter-serialization" title="Permalink to this headline">¶</a></h2>
<p>In the same way as for application-defined events, custom serializers for <a class="reference internal" href="event-log.html#replication-filters"><span>Replication filters</span></a> can also be configured via Akka&#8217;s <a class="reference external" href="http://doc.akka.io/docs/akka/2.3.9/scala/serialization.html">serialization extension</a>. For example, an application that wants to use a custom <code class="docutils literal"><span class="pre">MyReplicationFilterSerializer</span></code> for replication filters of type <code class="docutils literal"><span class="pre">MyReplicationFilter</span></code> (both defined in package <code class="docutils literal"><span class="pre">com.example</span></code>) should add the following configuration to <code class="docutils literal"><span class="pre">application.conf</span></code>:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">actor</span> <span class="o">{</span>
  <span class="n">serializers</span> <span class="o">{</span>
    <span class="n">custom</span><span class="o">-</span><span class="n">filter</span><span class="o">-</span><span class="n">serializer</span> <span class="k">=</span> <span class="s">&quot;com.example.MyReplicationFilterSerializer&quot;</span>
  <span class="o">}</span>

  <span class="n">serialization</span><span class="o">-</span><span class="n">bindings</span> <span class="o">{</span>
    <span class="s">&quot;com.example.MyReplicationFilter&quot;</span> <span class="k">=</span> <span class="n">custom</span><span class="o">-</span><span class="n">filter</span><span class="o">-</span><span class="n">serializer</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Custom replication filter serialization also works if the custom filter is part of a composite filter that has been composed with <code class="docutils literal"><span class="pre">and</span></code> or <code class="docutils literal"><span class="pre">or</span></code> combinators (see <a class="reference external" href="../latest/api/index.html#com.rbmhtechnology.eventuate.ReplicationFilter">ReplicationFilter</a> API). If no custom filter serializer is configured, Akka’s default serializer is used.</p>
</div>
<div class="section" id="custom-snapshot-serialization">
<span id="snapshot-serialization"></span><h2>Custom snapshot serialization<a class="headerlink" href="#custom-snapshot-serialization" title="Permalink to this headline">¶</a></h2>
<p>Applications can also configure custom serializers for snapshots in the same way as for application-defined events and replication filters (see sections <a class="reference internal" href="#event-serialization"><span>Custom event serialization</span></a> and <a class="reference internal" href="#replication-filter-serialization"><span>Custom replication filter serialization</span></a>).</p>
<p>Custom snapshot serialization also works for state managed with <code class="docutils literal"><span class="pre">ConcurrentVersions[A,</span> <span class="pre">B]</span></code>. A custom serializer configured for type parameter <code class="docutils literal"><span class="pre">A</span></code> is used whenever a snapshot of type <code class="docutils literal"><span class="pre">ConcurrentVersions[A,</span> <span class="pre">B]</span></code> is saved (see also <a class="reference internal" href="../user-guide.html#tracking-conflicting-versions"><span>Tracking conflicting versions</span></a>).</p>
<table class="docutils footnote" frame="void" id="id12" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[1]</a></td><td>An explicit <code class="docutils literal"><span class="pre">onEvent</span></code> call may become obsolete in future releases.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id13" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[2]</a></td><td>The <code class="docutils literal"><span class="pre">customDestinationAggregateIds</span></code> parameter is described in section <a class="reference internal" href="#event-routing"><span>Event routing</span></a>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id14" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[3]</a></td><td>Writes from different event-sourced actors that have <code class="docutils literal"><span class="pre">stateSync</span></code> set to <code class="docutils literal"><span class="pre">true</span></code> are still batched, but not the writes from a single event-sourced actor.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id15" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[4]</a></td><td>Event replay can optionally start from <a class="reference internal" href="#snapshots"><span>Snapshots</span></a> of actor state.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id16" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id9">[5]</a></td><td><a class="reference internal" href="../architecture.html#processors"><span>Event-sourced processors</span></a> can additionally route events between event logs.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id17" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id10">[6]</a></td><td>The routing destinations of a <a class="reference external" href="../latest/api/index.html#com.rbmhtechnology.eventuate.DurableEvent">DurableEvent</a> can be obtained with its <code class="docutils literal"><span class="pre">destinationAggregateIds</span></code> method.</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
		    
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="configuration.html" class="float-right" title="Configuration">Next</a>
      
      
        <a href="event-log.html" title="Event log">Previous</a>
      
    </div>
  
        </div>
	  </div>
    <div class="wrapper-footer">
<footer>
  <div role="contentinfo">
    <p>
        &copy; Copyright 2015 Red Bull Media House.  | <a href="http://rbmhtechnology.github.io/imprint" target="_blank">Imprint</a> | <a href="http://rbmhtechnology.github.io/termsconditions" target="_blank">Terms &amp; Conditions</a> | <a href="http://rbmhtechnology.github.io/dataprivacypolicy" target="_blank">Data Privacy Policy</a> 
    </p>
  </div>

</footer>
</div>
      
    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.3-SNAPSHOT',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>